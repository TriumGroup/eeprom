#include "p16f84.inc"

c_array_base equ 0x010
c_array_size equ 0xA
c_eeprom_location equ 0x0

v_i equ 0x0c
v_error equ 0x0D

	GOTO BEGIN	

INITIALIZE_ARRAY:
	MOVLW c_array_size
	MOVWF v_i
	MOVLW c_array_base-1
	MOVWF FSR 

INITIALIZE_LOOP:
	INCF FSR, F
	MOVF v_i, W
	SUBLW c_array_size
	MOVWF INDF

	DECFSZ v_i, F
	GOTO INITIALIZE_LOOP

	RETURN


COPY_TO_EEPROM:
	BCF STATUS, RP0
	CLRF v_error
	MOVLW c_array_size
	MOVWF v_i
	MOVLW c_eeprom_location-1
	MOVWF EEADR
	MOVLW c_array_base-1
	MOVWF FSR

LOOP:
	INCF EEADR, F
	INCF FSR, F

WRITE:
	MOVF INDF, W
	MOVWF EEDATA

	BSF STATUS, RP0
	BCF INTCON, GIE
	BSF EECON1, WREN
	MOVLW 0x55
	MOVWF EECON2
	MOVLW 0xAA
	MOVWF EECON2
	BSF EECON1, WR
	BSF INTCON, GIE

WAIT_FOR_WRITE:
	BTFSC EECON1, WR
	GOTO WAIT_FOR_WRITE

	BCF EECON1, WREN


	BCF STATUS, RP0
	MOVF EEDATA, W
	BSF STATUS, RP0

	BSF EECON1, RD
	BCF STATUS, RP0

	SUBWF EEDATA, W
	BTFSS STATUS, Z
	GOTO WRITE_ERROR

	DECFSZ v_i, F
	GOTO LOOP	

	RETURN

WRITE_ERROR:
	MOVLW 0x01
	MOVWF v_error
	RETURN


BEGIN:
	CALL INITIALIZE_ARRAY	
	CALL COPY_TO_EEPROM
	
	end
